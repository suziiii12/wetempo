<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                timeZone: 'UTC',
                initialView: 'dayGridMonth', // 월별 뷰로 설정
                events: [],
                headerToolbar: {
                    center: 'addEventButton icsUploadButton icsDownloadButton syncICSButton'
                },
                customButtons: {
                    addEventButton: {
                        text: "일정 추가",
                        click: function () {
                            $("#calendarModal").modal("show");
    
                            $("#addCalendar").off("click").on("click", function () { // off()로 이전 이벤트 제거
                                var content = $("#calendar_content").val();
                                var start_date = $("#calendar_start_date").val();
                                var start_time = $("#calendar_start_time").val();
                                var end_date = $("#calendar_end_date").val();
                                var end_time = $("#calendar_end_time").val();
                                var location = $("#calendar_location").val();
                                var description = $("#calendar_description").val();
    
                                if (!content) {
                                    alert("내용을 입력하세요.");
                                } else if (!start_date || !end_date || !start_time || !end_time) {
                                    alert("날짜와 시간을 입력하세요.");
                                } else if (new Date(end_date + ' ' + end_time) < new Date(start_date + ' ' + start_time)) {
                                    alert("종료일이 시작일보다 먼저입니다.");
                                } else {
                                    var startDateTime = new Date(start_date + ' ' + start_time);
                                    var endDateTime = new Date(end_date + ' ' + end_time);
                                    var conflictingEvent = calendar.getEvents().find(event => {
                                        return event.start < endDateTime && startDateTime < event.end; // 시간 중첩 확인
                                    });
    
                                    if (conflictingEvent) {
                                        alert("해당 시간에 이미 일정이 있습니다.");
                                    } else {
                                        calendar.addEvent({
                                            title: content,
                                            start: startDateTime.toISOString(),
                                            end: endDateTime.toISOString(),
                                            location: location,
                                            description: description
                                        });
                                        $("#calendarModal").modal("hide");
                                    }
                                }
                            });
                        }
                    },
                    icsUploadButton: {
                        text: "ICS 업로드",
                        click: function () {
                            $("#icsUploadInput").click();
                        }
                    },
                    icsDownloadButton: {
                        text: "ICS 다운로드",
                        click: function () {
                            var cal = ics();
                            var events = calendar.getEvents();
    
                            events.forEach(event => {
                                cal.addEvent(
                                    event.title,
                                    event.extendedProps.description || '',
                                    event.start.toISOString(),
                                    event.end.toISOString(),
                                    event.extendedProps.location || ''
                                );
                            });
    
                            cal.download('calendar');
                        }
                    },
                    syncICSButton: {
                        text: "ICS 동기화",
                        click: function () {
                            const url = prompt("ICS URL을 입력하세요 (예: webcal://...)");
                            if (url) {
                                fetchAndParseICS(url);
                            }
                        }
                    }
                },
                editable: true,
                displayEventTime: true
            });
            calendar.render();
    
            // ICS 파일 업로드
            $("#icsUploadInput").on("change", function (e) {
                var file = e.target.files[0];
                var reader = new FileReader();
    
                reader.onload = function (e) {
                    var icsData = e.target.result;
                    var parsedEvents = parseICS(icsData);
    
                    parsedEvents.forEach(function (event) {
                        calendar.addEvent({
                            title: event.summary,
                            start: event.start.toISOString(),
                            end: event.end.toISOString(),
                            location: event.location,
                            description: event.description
                        });
                    });
                };
    
                reader.readAsText(file);
            });
    
            function parseICS(icsData) {
                var jcal = ICAL.parse(icsData);
                var comp = new ICAL.Component(jcal);
                var vevents = comp.getAllSubcomponents('vevent');
                var events = [];
    
                vevents.forEach(function (vevent) {
                    var event = {
                        summary: vevent.getFirstPropertyValue('summary'),
                        start: vevent.getFirstPropertyValue('dtstart').toJSDate(),
                        end: vevent.getFirstPropertyValue('dtend').toJSDate(),
                        location: vevent.getFirstPropertyValue('location'),
                        description: vevent.getFirstPropertyValue('description')
                    };
                    events.push(event);
                });
    
                return events;
            }
    
            async function fetchAndParseICS(url) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('네트워크 오류 발생');
    
                    // 기존 일정 삭제
                    calendar.removeAllEvents();
    
                    const icsData = await response.text();
                    const parsedEvents = parseICS(icsData);
    
                    parsedEvents.forEach(function (event) {
                        calendar.addEvent({
                            title: event.summary,
                            start: event.start.toISOString(),
                            end: event.end.toISOString(),
                            location: event.location,
                            description: event.description
                        });
                    });
                } catch (error) {
                    alert('ICS 파일 가져오기 오류: ' + error.message);
                    console.error('ICS 파일 가져오기 오류:', error);
                }
            }
        });
    </script>
</head>
<body>
    
</body>
</html>



